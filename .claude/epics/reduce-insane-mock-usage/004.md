---
name: Create test database utilities (SQLite in-memory)
status: open
created: 2025-09-20T01:15:53Z
updated: 2025-09-20T01:15:53Z
github: [Will be updated when synced to GitHub]
depends_on: [002]
parallel: true
conflicts_with: []
---

# Create test database utilities (SQLite in-memory)

## Description

Implement SQLite in-memory database utilities to provide fast, reliable database testing without the complexity and overhead of mocked database interactions. This approach ensures tests run against real SQL operations while maintaining speed and isolation.

## Acceptance Criteria

- [ ] SQLite in-memory database setup utilities
- [ ] Database schema migration utilities for tests
- [ ] Seed data management for consistent test scenarios
- [ ] Transaction rollback capabilities for test isolation
- [ ] Database state inspection and assertion utilities
- [ ] Performance optimizations for test speed
- [ ] Cleanup mechanisms to prevent memory leaks
- [ ] Support for concurrent test execution

## Technical Details

### Database Utilities Structure
```typescript
// tests/fixtures/db/sqlite.ts
export class TestDatabase {
  async setup(): Promise<Database>
  async seed(scenario: string): Promise<void>
  async cleanup(): Promise<void>
  async transaction<T>(fn: () => Promise<T>): Promise<T>
}
```

### Key Components
1. **Database Factory**: Creates fresh in-memory SQLite instances
2. **Schema Manager**: Applies migrations and schema changes
3. **Seed Data Manager**: Loads predefined test scenarios
4. **Transaction Manager**: Handles test isolation through transactions
5. **Query Builder**: Utilities for common test database operations
6. **Assertion Helpers**: Database state verification utilities

### Test Isolation Strategy
- Each test gets a fresh database instance OR
- Transaction-based isolation with automatic rollback
- Configurable isolation levels based on test requirements
- Parallel test support through separate database instances

### Performance Optimizations
- WAL mode for better concurrent access
- Optimized SQLite pragma settings for tests
- Memory-only operation (no disk I/O)
- Connection pooling for frequently accessed databases
- Lazy loading of seed data

### Seed Data Management
- YAML or JSON fixture files for different scenarios
- Programmatic builders for complex data relationships
- Incremental seeding for specific test requirements
- Realistic data generation utilities

## Dependencies

- **Task 002**: Requires shared fixtures directory structure
- **SQLite3**: Database engine (likely through better-sqlite3)
- **Migration Tools**: Schema management utilities

## Effort Estimate

**Size**: Medium (2 days)
- Day 1: Implement core database utilities and schema management
- Day 2: Add seed data management, performance optimizations, and cleanup

## Definition of Done

- [ ] SQLite in-memory database utilities are functional
- [ ] Test isolation is guaranteed through transactions or fresh instances
- [ ] Seed data can be easily managed and applied
- [ ] Performance is optimized for test execution speed
- [ ] Memory leaks are prevented through proper cleanup
- [ ] Concurrent test execution is supported
- [ ] Documentation covers common usage patterns
- [ ] Integration with existing test infrastructure is seamless