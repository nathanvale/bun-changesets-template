---
name: Replace database mocking with SQLite integration tests
status: open
created: 2025-09-20T01:15:53Z
updated: 2025-09-20T01:15:53Z
github: [Will be updated when synced to GitHub]
depends_on: [004, 016, 017]
parallel: true
conflicts_with: []
---

# Task 023: Replace database mocking with SQLite integration tests

## Description

Replace database mocking with real SQLite in-memory databases for integration
testing. This provides realistic database behavior while maintaining test speed
and isolation.

## Acceptance Criteria

- [ ] All database mocks replaced with SQLite in-memory instances
- [ ] Database schema migrations run in test environment
- [ ] Test data seeding and cleanup implemented
- [ ] Transaction isolation between tests maintained
- [ ] Database constraints and relationships properly tested
- [ ] Performance comparable to mocked implementations
- [ ] SQL query validation with real database engine

## Technical Details

### SQLite Test Database Setup

```typescript
class TestDatabase {
  private db: Database

  async setup(): Promise<Database> {
    this.db = new Database(':memory:')
    await this.runMigrations()
    return this.db
  }

  async runMigrations(): Promise<void> {
    // Run actual schema migrations
    const migrations = await loadMigrationFiles()
    for (const migration of migrations) {
      await this.db.exec(migration.sql)
    }
  }

  async seed(fixtures: DatabaseFixtures): Promise<void> {
    // Insert test data using real INSERT statements
  }

  async cleanup(): Promise<void> {
    await this.db.close()
  }
}
```

### Integration Patterns

- Per-test database instances
- Shared schema with isolated data
- Transaction rollback strategies
- Fixture data management
- Query performance testing

### Areas to Convert

- Repository layer tests
- Service layer database integration tests
- Migration testing
- Query optimization tests
- Database constraint validation tests

## Dependencies

- **Task 004**: Database testing infrastructure (provides foundation)
- **Task 016**: Replace unit mocks with integration patterns (establishes
  approach)
- **Task 017**: Establish promotion rule enforcement (provides guidelines)

## Effort Estimate

**Size**: Large (3 days)

**Breakdown**:

- Day 1: Set up SQLite test infrastructure and migration system
- Day 2: Convert repository and service layer tests
- Day 3: Optimize performance and implement advanced testing patterns

## Definition of Done

- [ ] No database mocks remain in test suite
- [ ] All database tests use real SQLite instances
- [ ] Database schema migrations tested with real database
- [ ] Test data fixtures use actual INSERT/UPDATE operations
- [ ] Transaction isolation verified between tests
- [ ] Database constraints and foreign keys properly tested
- [ ] Performance benchmarks meet requirements (sub-second test runs)
