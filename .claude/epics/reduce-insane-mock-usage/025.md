---
name: Create integration test patterns for service → repo → DB flows
status: open
created: 2025-09-20T01:15:53Z
updated: 2025-09-20T01:15:53Z
github: [Will be updated when synced to GitHub]
depends_on: [021, 022, 023, 024]
parallel: true
conflicts_with: []
---

# Task 025: Create integration test patterns for service → repo → DB flows

## Description

Establish comprehensive integration test patterns that test complete data flows
from service layer through repository layer to database, eliminating the need
for intermediate mocking.

## Acceptance Criteria

- [ ] End-to-end integration test patterns established
- [ ] Service → Repository → Database flows tested without mocks
- [ ] Transaction boundary testing implemented
- [ ] Error propagation testing from all layers
- [ ] Performance benchmarks for integration patterns
- [ ] Data consistency validation across layers
- [ ] Rollback and cleanup strategies implemented

## Technical Details

### Integration Test Patterns

```typescript
describe('User Service Integration', () => {
  let testDb: TestDatabase
  let userRepo: UserRepository
  let userService: UserService

  beforeEach(async () => {
    testDb = await TestDatabase.create()
    userRepo = new UserRepository(testDb.connection)
    userService = new UserService(userRepo)
  })

  it('creates user with validation and persistence', async () => {
    const userData = { name: 'John Doe', email: 'john@example.com' }

    // Test complete flow: validation → business logic → persistence
    const user = await userService.createUser(userData)

    // Verify data was persisted correctly
    const persisted = await testDb.query('SELECT * FROM users WHERE id = ?', [
      user.id,
    ])
    expect(persisted[0]).toMatchObject(userData)
  })
})
```

### Flow Categories

- Create operations (validation → persistence → indexing)
- Update operations (conflict detection → modification → audit)
- Delete operations (dependency checking → cascading → cleanup)
- Query operations (filtering → joining → aggregation)
- Batch operations (transaction management → rollback handling)

### Error Scenario Testing

- Database constraint violations
- Transaction deadlocks and conflicts
- Network interruptions during operations
- Partial failure recovery
- Data consistency validation

## Dependencies

- **Task 021**: Boundary adapter pattern (provides adapter interfaces)
- **Task 022**: File system temp directories (provides file operation patterns)
- **Task 023**: SQLite integration tests (provides database infrastructure)
- **Task 024**: MSW HTTP handlers (provides HTTP interaction patterns)

## Effort Estimate

**Size**: Large (3 days)

**Breakdown**:

- Day 1: Design integration test patterns and infrastructure
- Day 2: Implement core service-to-database flow patterns
- Day 3: Add error scenarios and performance optimization

## Definition of Done

- [ ] Complete integration test patterns documented and implemented
- [ ] All major service → repository → database flows covered
- [ ] Transaction boundaries properly tested
- [ ] Error propagation verified from all layers
- [ ] Performance benchmarks established and met
- [ ] Data consistency validation patterns implemented
- [ ] Cleanup and rollback strategies verified
