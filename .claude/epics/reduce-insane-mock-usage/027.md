# Task 027: Apply "mock only at trust boundaries" throughout codebase

**Epic:** reduce-insane-mock-usage **Phase:** Phase 3 - Architecture
Transformation **Created:** 2025-09-20T02:15:00Z **Updated:**
2025-09-20T02:15:00Z **Status:** pending **Size:** XLarge **Parallel:** false
**Depends on:** [021, 022, 023, 024, 025, 026]

## Objective

Systematically apply the "mock only at trust boundaries" principle throughout
the entire codebase, ensuring all internal mocking is eliminated and replaced
with appropriate testing strategies.

## Success Criteria

- [ ] All internal service/repository mocks removed
- [ ] Mocking only used at system boundaries (external APIs, databases, file
      systems)
- [ ] Trust boundary violations documented and justified
- [ ] Test performance maintained or improved
- [ ] Code coverage maintained at current levels
- [ ] All promotion rules validated across codebase

## Tasks

1. **Audit current mocking usage**
   - Scan entire codebase for mock usage patterns
   - Classify mocks as internal vs. boundary mocks
   - Document violations and create remediation plan

2. **Remove internal service mocks**
   - Replace service layer mocks with real implementations
   - Update tests to use integration patterns where appropriate
   - Ensure proper dependency injection for testability

3. **Remove internal repository mocks**
   - Replace repository mocks with SQLite-based tests
   - Update service tests to use real repository implementations
   - Maintain test isolation through database management

4. **Validate boundary mocking**
   - Ensure external service mocks use MSW or adapter fakes
   - Verify file system operations use temp directories or storage fakes
   - Confirm database mocking only at connection boundaries

5. **Update test organization**
   - Reorganize tests according to new patterns
   - Update test naming conventions to reflect new architecture
   - Ensure clear separation between unit and integration tests

## Architecture Impact

- Dramatically improves test reliability and maintainability
- Reduces coupling between test and implementation details
- Enables safe refactoring through realistic test coverage
- Establishes clear architectural boundaries

## Testing Strategy

- Comprehensive test suite validation after each change
- Performance monitoring to ensure acceptable test execution
- Coverage analysis to identify any gaps introduced
- Manual testing of critical flows to verify behavior

## Notes

- This is the largest and most critical task in the epic
- Requires careful coordination with all previous tasks
- Success depends on proper implementation of adapter and fake infrastructure
