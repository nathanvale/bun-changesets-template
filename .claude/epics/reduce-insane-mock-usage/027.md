---
name: Apply "mock only at trust boundaries" throughout codebase
status: open
created: 2025-09-20T01:15:53Z
updated: 2025-09-20T01:15:53Z
github: [Will be updated when synced to GitHub]
depends_on: [021, 022, 023, 024, 025, 026]
parallel: false
conflicts_with: []
---

# Task 027: Apply "mock only at trust boundaries" throughout codebase

## Description

Systematically apply the "mock only at trust boundaries" principle throughout the entire codebase, eliminating internal mocking while preserving mocks only at external system boundaries. This is a comprehensive refactoring that touches most test files.

## Acceptance Criteria

- [ ] All internal component mocks removed from test suite
- [ ] Mocks only exist at external system boundaries
- [ ] Trust boundary documentation updated
- [ ] Test coverage maintained or improved
- [ ] Test execution time within acceptable limits
- [ ] All tests pass with new mocking strategy
- [ ] Code review checklist updated with boundary mocking rules

## Technical Details

### Trust Boundary Identification
```typescript
// ✅ ALLOWED: Mock at external boundaries
const mockEmailService = jest.fn(); // External service
const mockDatabaseConnection = jest.fn(); // External system
const mockHttpClient = jest.fn(); // External API

// ❌ FORBIDDEN: Mock internal components
const mockUserRepository = jest.fn(); // Internal component
const mockValidator = jest.fn(); // Internal utility
const mockBusinessLogic = jest.fn(); // Internal service
```

### Refactoring Categories
1. **Service Layer Tests**: Remove repository mocks, use real repositories with test databases
2. **Repository Layer Tests**: Remove database mocks, use SQLite in-memory instances
3. **Controller Layer Tests**: Remove service mocks, use real services with fake external adapters
4. **Utility Function Tests**: Remove all mocks, test with real implementations
5. **Integration Tests**: Use real implementations throughout, mock only external boundaries

### Migration Strategy
- Identify current mock usage patterns
- Categorize mocks as internal vs. external
- Replace internal mocks with real implementations
- Retain external boundary mocks with proper abstractions
- Update test assertions to work with real behavior

## Dependencies

- **Task 021**: Boundary adapter pattern (defines trust boundaries)
- **Task 022**: File system temp directories (provides file system testing)
- **Task 023**: SQLite integration tests (provides database testing)
- **Task 024**: MSW HTTP handlers (provides HTTP testing)
- **Task 025**: Integration test patterns (provides flow testing)
- **Task 026**: Adapter fakes (provides external service testing)

## Effort Estimate

**Size**: XLarge (5 days)

**Breakdown**:
- Day 1: Audit existing mocks and categorize by boundary type
- Day 2: Refactor service and repository layer tests
- Day 3: Refactor controller and utility tests
- Day 4: Update integration tests and fix edge cases
- Day 5: Performance optimization and documentation updates

## Definition of Done

- [ ] Comprehensive audit of all mocks completed
- [ ] Internal mocks eliminated from entire codebase
- [ ] External boundary mocks properly abstracted
- [ ] All tests pass with new mocking strategy
- [ ] Test coverage reports show maintained or improved coverage
- [ ] Performance benchmarks within acceptable limits
- [ ] Documentation updated with trust boundary guidelines
- [ ] Code review process includes boundary mocking validation