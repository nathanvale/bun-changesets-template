---
name: Implement fake time/random utilities
status: open
created: 2025-09-20T01:15:53Z
updated: 2025-09-20T01:15:53Z
github: [Will be updated when synced to GitHub]
depends_on: [002]
parallel: true
conflicts_with: []
---

# Implement fake time/random utilities

## Description

Create deterministic time and randomness utilities to eliminate flaky tests
caused by time-dependent logic and random values. This replaces unreliable
mocking approaches with controlled, predictable alternatives that make tests
reliable and debuggable.

## Acceptance Criteria

- [ ] Fake time utilities with controllable time progression
- [ ] Deterministic random number generation with seedable RNG
- [ ] Date/time manipulation utilities for testing time-based logic
- [ ] Timer and interval mocking without affecting real timers
- [ ] UUID generation with deterministic output for tests
- [ ] Timezone simulation utilities
- [ ] Performance measurement mocking for consistent benchmarks
- [ ] Integration with existing test infrastructure

## Technical Details

### Time Utilities Structure

```typescript
// tests/fixtures/time/fake-time.ts
export class FakeTime {
  static freeze(date: Date): void
  static travel(milliseconds: number): void
  static reset(): void
  static now(): Date
}

// tests/fixtures/random/deterministic.ts
export class DeterministicRandom {
  constructor(seed: string | number)
  next(): number
  uuid(): string
  integer(min: number, max: number): number
  pick<T>(array: T[]): T
}
```

### Key Components

1. **Time Controller**: Manages fake time progression and freezing
2. **Timer Manager**: Controls setTimeout, setInterval, and related functions
3. **Random Generator**: Seeded pseudo-random number generation
4. **UUID Generator**: Deterministic UUID creation for consistent tests
5. **Date Builder**: Utilities for creating specific dates and times
6. **Performance Mock**: Consistent performance.now() values

### Time Management Features

- Freeze time at specific moments for consistent testing
- Advance time by specific intervals to test time-based logic
- Simulate different timezones and daylight saving transitions
- Control async operations that depend on time
- Test timeout and retry logic with accelerated time

### Randomness Control

- Seedable random number generation for reproducible tests
- Deterministic UUIDs that remain consistent across test runs
- Controllable random selections from arrays or ranges
- Fake data generation with consistent output
- Random boolean and percentage-based decisions

### Integration Considerations

- Compatible with existing timer-based code
- Non-invasive mocking that doesn't affect production code
- Easy setup and teardown for individual tests
- Support for nested time zones and complex time scenarios
- Performance impact minimization

### Common Test Scenarios

- Testing retry mechanisms with exponential backoff
- Validating time-based cache expiration
- Testing scheduled tasks and cron-like functionality
- Verifying timeout handling in async operations
- Testing date-based business logic

## Dependencies

- **Task 002**: Requires shared fixtures directory structure
- **Seedable RNG**: Deterministic random number generation library
- **Time Mocking**: Integration with test framework timing

## Effort Estimate

**Size**: Small (1 day)

- Morning: Implement fake time utilities and timer controls
- Afternoon: Add deterministic random generation and UUID utilities

## Definition of Done

- [ ] Time can be frozen and controlled for deterministic testing
- [ ] Random values are deterministic and reproducible across test runs
- [ ] Timer-based operations can be tested without real time delays
- [ ] UUID generation produces consistent values for tests
- [ ] Timezone and complex time scenarios are supported
- [ ] Integration with test lifecycle ensures proper cleanup
- [ ] Performance impact on test execution is minimal
- [ ] Documentation covers common time and randomness testing patterns
