---
name: Validate promotion rule compliance across all tests
status: open
created: 2025-09-20T01:15:53Z
updated: 2025-09-20T01:15:53Z
github: [Will be updated when synced to GitHub]
depends_on: [027]
parallel: true
conflicts_with: []
---

# Task 029: Validate promotion rule compliance across all tests

## Description

Implement automated validation to ensure all tests follow the ">2 mock
promotion" rule, where tests using more than 2 mocks are promoted to integration
tests or refactored to use real implementations.

## Acceptance Criteria

- [ ] Automated mock counting tool implemented
- [ ] CI/CD integration prevents >2 mock violations
- [ ] Test classification validation (unit vs integration)
- [ ] Violation reporting with actionable suggestions
- [ ] Exemption system for edge cases
- [ ] Historical tracking of mock usage trends
- [ ] Developer tooling for real-time feedback

## Technical Details

### Mock Detection System

```typescript
class MockUsageValidator {
  analyzeTestFile(filePath: string): MockUsageReport {
    const ast = parseTestFile(filePath)
    const mocks = this.findMockUsage(ast)

    return {
      filePath,
      testSuites: mocks.map((suite) => ({
        name: suite.name,
        mockCount: suite.mocks.length,
        violations:
          suite.mocks.length > 2
            ? [
                {
                  rule: 'max-mocks',
                  severity: 'error',
                  suggestion:
                    'Consider promoting to integration test or using real implementations',
                },
              ]
            : [],
      })),
    }
  }

  private findMockUsage(ast: AST): MockSuite[] {
    // Detect jest.mock(), jest.fn(), vi.mock(), etc.
    // Track mock usage per test suite
  }
}
```

### Validation Rules

- **Max Mock Rule**: Unit tests limited to 2 mocks maximum
- **Integration Classification**: Tests with >2 mocks must be in integration
  test directories
- **Boundary Mock Rule**: Only external boundary mocks allowed
- **Mock Complexity Rule**: Complex mock setups indicate need for real
  implementations

### CI/CD Integration

- Pre-commit hook validation
- GitHub Actions check for mock compliance
- Pull request comments with violation summaries
- Trend analysis in test reports

## Dependencies

- **Task 027**: Mock boundary application (establishes compliant codebase)

## Effort Estimate

**Size**: Medium (2 days)

**Breakdown**:

- Day 1: Implement mock detection and validation system
- Day 2: Integrate with CI/CD and create developer tooling

## Definition of Done

- [ ] Mock counting tool accurately detects all mock usage
- [ ] CI/CD pipeline enforces promotion rule compliance
- [ ] Test classification validation prevents misplaced tests
- [ ] Violation reports provide clear actionable guidance
- [ ] Exemption system handles legitimate edge cases
- [ ] Historical tracking shows improvement trends
- [ ] Developer tooling provides real-time feedback during development
