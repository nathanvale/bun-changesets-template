---
id: 001
title: Capture current memory usage baseline
epic: test-suite-optimization
status: ready
priority: critical
depends_on: []
parallel: []
estimated_hours: 4
labels:
  - measurement
  - baseline
  - memory-profiling
---

# Task 001: Capture current memory usage baseline

## Objective

Capture comprehensive baseline memory metrics before any optimizations to enable
before/after comparison.

## Background

We need to establish current memory consumption patterns across the test suite
to measure the impact of optimizations. This baseline will be our reference
point for detecting improvements or regressions.

## Requirements

### Must Have

- [ ] Memory usage per test file
- [ ] Peak memory consumption during full test run
- [ ] Memory growth patterns over time
- [ ] Heap snapshot at test completion
- [ ] Baseline report in .claude/metrics/

### Nice to Have

- [ ] Memory usage by test type (unit/integration/e2e)
- [ ] Visualization of memory patterns
- [ ] Comparison with Node.js memory limits

## Implementation Details

### Step 1: Create memory profiling script

Create `scripts/memory-baseline.js`:

- Use `process.memoryUsage()` for runtime tracking
- Capture v8.getHeapSnapshot() at key points
- Track RSS, heap used, heap total, external memory
- Export data to JSON format

### Step 2: Instrument test execution

- Add memory hooks to Vitest configuration
- Track memory before/after each test file
- Log memory growth during test runs
- Capture final heap state

### Step 3: Run baseline capture

Execute full test suite with profiling:

```bash
NODE_OPTIONS='--expose-gc --max-old-space-size=4096' pnpm test
```

### Step 4: Generate baseline report

Create `.claude/metrics/baseline-memory-{timestamp}.json`:

```json
{
  "timestamp": "2025-09-19T10:00:00Z",
  "summary": {
    "peak_memory_mb": 1234,
    "avg_memory_mb": 567,
    "total_tests": 234,
    "duration_ms": 45678
  },
  "per_file": {...},
  "growth_pattern": [...]
}
```

## Acceptance Criteria

- [ ] Memory baseline script created and functional
- [ ] Full test suite memory profile captured
- [ ] Baseline report generated in .claude/metrics/
- [ ] Documentation of baseline metrics
- [ ] Can reproduce baseline capture on demand

## Testing

- Run memory baseline script multiple times
- Verify consistent measurements across runs
- Confirm all test files are tracked
- Check report format is valid JSON

## Risks

- Memory profiling overhead may affect measurements
- Different environments may show different baselines
- Large heap snapshots may cause OOM errors

## Dependencies

- Node.js v8 module for heap snapshots
- process.memoryUsage() API
- Existing test suite must be runnable

## Notes

This is the CRITICAL first step - no other optimizations should begin until
baseline is captured.
