---
id: 004
title: Create zombie process tracking system
epic: test-suite-optimization
status: ready
priority: high
depends_on: ['001', '002', '003']
parallel: []
estimated_hours: 6
labels:
  - zombie-prevention
  - process-management
  - core-infrastructure
---

# Task 004: Create zombie process tracking system

## Objective

Implement a system to track all spawned processes during test execution and
ensure they are properly terminated.

## Background

Currently, node(vitest) processes persist after test completion. We need a
tracking system that monitors all spawned processes and ensures cleanup,
preventing zombie accumulation.

## Requirements

### Must Have

- [ ] Track all child processes spawned during tests
- [ ] Map processes to their parent test files
- [ ] Detect orphaned/zombie processes
- [ ] Provide process cleanup API
- [ ] Integration with Vitest lifecycle

### Nice to Have

- [ ] Real-time process monitoring dashboard
- [ ] Process tree visualization
- [ ] Memory usage per process tracking

## Implementation Details

### Step 1: Create process tracker module

Create `packages/quality-check/src/process-tracker.ts`:

```typescript
interface ProcessInfo {
  pid: number
  ppid: number
  testFile: string
  startTime: Date
  command: string
  status: 'running' | 'terminated' | 'zombie'
}

class ProcessTracker {
  private processes: Map<number, ProcessInfo>

  trackProcess(pid: number, testFile: string): void
  terminateProcess(pid: number): Promise<void>
  terminateAll(): Promise<void>
  getZombieProcesses(): ProcessInfo[]
  getProcessesByTest(testFile: string): ProcessInfo[]
}
```

### Step 2: Hook into Node.js process spawning

Override child_process methods:

```typescript
// Wrap spawn, exec, fork to track processes
const originalSpawn = childProcess.spawn
childProcess.spawn = function (...args) {
  const child = originalSpawn.apply(this, args)
  processTracker.trackProcess(child.pid, currentTestFile)
  return child
}
```

### Step 3: Integrate with Vitest hooks

Add to `vitest.setup.ts`:

```typescript
import { beforeEach, afterEach, afterAll } from 'vitest'

beforeEach(({ task }) => {
  processTracker.setCurrentTest(task.file.name)
})

afterEach(async ({ task }) => {
  const processes = processTracker.getProcessesByTest(task.file.name)
  await Promise.all(
    processes.map((p) => processTracker.terminateProcess(p.pid)),
  )
})

afterAll(async () => {
  await processTracker.terminateAll()
  const zombies = processTracker.getZombieProcesses()
  if (zombies.length > 0) {
    console.error(`Warning: ${zombies.length} zombie processes detected`)
  }
})
```

### Step 4: Implement force termination

Add aggressive cleanup methods:

```typescript
async terminateProcess(pid: number): Promise<void> {
  try {
    process.kill(pid, 'SIGTERM');
    await this.waitForTermination(pid, 5000);
  } catch {
    process.kill(pid, 'SIGKILL'); // Force kill if SIGTERM fails
  }
}

private async waitForTermination(pid: number, timeout: number): Promise<void> {
  const start = Date.now();
  while (Date.now() - start < timeout) {
    if (!this.isProcessRunning(pid)) return;
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  throw new Error(`Process ${pid} did not terminate within ${timeout}ms`);
}
```

### Step 5: Add monitoring utilities

Create CLI commands:

```bash
# Check for zombie processes
pnpm zombies:check

# Kill all test-related processes
pnpm zombies:kill

# Monitor processes in real-time
pnpm zombies:monitor
```

## Acceptance Criteria

- [ ] ProcessTracker class implemented and tested
- [ ] All child processes are tracked during tests
- [ ] Processes are terminated after each test
- [ ] Zero zombies after full test suite run
- [ ] CLI utilities for process management

## Testing

- Spawn processes in tests and verify tracking
- Confirm processes are terminated after tests
- Test force kill functionality
- Verify no zombies in Activity Monitor

## Risks

- May interfere with legitimate long-running processes
- Force killing may corrupt test state
- Performance overhead from tracking

## Dependencies

- Node.js child_process module
- Vitest hooks system
- Unix process management tools

## Notes

This is the foundation for zombie prevention. Must be rock-solid before
proceeding with other zombie-related tasks.
