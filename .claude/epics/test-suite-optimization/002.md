---
id: 002
title: Document zombie process frequency
epic: test-suite-optimization
status: ready
priority: critical
depends_on: []
parallel: ["001"]
estimated_hours: 2
labels:
  - measurement
  - baseline
  - zombie-processes
---

# Task 002: Document zombie process frequency

## Objective

Establish baseline metrics for zombie process creation to measure the effectiveness of prevention mechanisms.

## Background

node(vitest) processes are persisting after test completion, accumulating in Activity Monitor and eventually crashing the development machine. We need to document the current frequency and patterns of zombie creation.

## Requirements

### Must Have
- [ ] Count of zombie processes after single test run
- [ ] Count of zombie processes after multiple test runs
- [ ] Process names and PIDs of zombies
- [ ] Memory consumption of zombie processes
- [ ] Baseline report in .claude/metrics/

### Nice to Have
- [ ] Correlation with specific test files
- [ ] Time-to-accumulation metrics
- [ ] CPU usage of zombie processes

## Implementation Details

### Step 1: Create zombie detection script
Create `scripts/detect-zombies.sh`:
```bash
#!/bin/bash
# Find all node processes related to vitest
ps aux | grep -E "node.*vitest" | grep -v grep
# Count zombie processes
ps aux | grep -E "node.*vitest" | grep -v grep | wc -l
# Get memory usage
ps aux | grep -E "node.*vitest" | grep -v grep | awk '{sum+=$6} END {print sum/1024 " MB"}'
```

### Step 2: Document current state
Before running any tests:
1. Clear all existing node processes
2. Document clean state in Activity Monitor
3. Take screenshot of clean state

### Step 3: Run test scenarios
Document zombies after:
1. Single test file run: `pnpm test single-file.test.ts`
2. Package test run: `pnpm test:package quality-check`
3. Full test suite: `pnpm test`
4. Multiple consecutive runs (5x)
5. Watch mode for 10 minutes

### Step 4: Generate baseline report
Create `.claude/metrics/baseline-zombies-{timestamp}.json`:
```json
{
  "timestamp": "2025-09-19T10:00:00Z",
  "scenarios": {
    "single_file": {
      "zombie_count": 1,
      "memory_mb": 45,
      "pids": [1234]
    },
    "full_suite": {
      "zombie_count": 15,
      "memory_mb": 675,
      "pids": [...]
    }
  },
  "accumulation_rate": "3 zombies per test run",
  "crash_threshold": "~50 zombie processes"
}
```

## Acceptance Criteria

- [ ] Zombie detection script created and functional
- [ ] Baseline measurements for all scenarios
- [ ] Activity Monitor screenshots captured
- [ ] Baseline report generated in .claude/metrics/
- [ ] Clear documentation of zombie patterns

## Testing

- Run detection script before and after tests
- Verify zombie counts are accurate
- Confirm PIDs match Activity Monitor
- Validate memory calculations

## Risks

- Manual process counting may be error-prone
- Different test runs may produce different zombie counts
- System may crash during measurement

## Dependencies

- Unix process management tools (ps, grep, awk)
- Activity Monitor for visual confirmation
- Ability to run full test suite

## Notes

Run this task in parallel with Task 001 (memory baseline) for efficiency.