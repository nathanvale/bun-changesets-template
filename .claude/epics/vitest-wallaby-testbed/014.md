---
name: Enforce import order with bootstrap
status: completed
created: 2025-09-20T21:07:43Z
updated: 2025-09-21T10:55:00Z
completed: 2025-09-21T10:55:00Z
github: # Will be updated when synced to GitHub
depends_on: [013]
parallel: false
conflicts_with: []
---

# Task: Enforce import order with bootstrap

## Description

Create a testkit bootstrap module that ensures vi.mock declarations and registry
initialization happen before any consumer imports. This guarantees correct mock
installation order and prevents timing-sensitive failures.

## Acceptance Criteria

- [x] Bootstrap module created that hoists all vi.mock declarations
- [x] Registry initialization happens in bootstrap before consumer code
- [x] Clear import pattern documented for test files
- [x] Test templates provided showing correct usage
- [x] Bootstrap handles all mockable modules (child_process, fs, etc.)
- [x] Import order violations produce clear error messages
- [x] Bootstrap integrates with `packages/testkit/src/register.ts` to ensure
      setupFiles usage works in both Vitest and Wallaby
- [x] Works when tests use either package-level or root-level vitest config (no
      drift)

## Technical Details

- Create `packages/testkit/src/bootstrap.ts` as entry point
- Bootstrap must be imported before test code
- Consider using side-effect imports for initialization
- May need to restructure test file imports
- Provide migration guide for existing tests

Key files affected:

- `packages/testkit/src/bootstrap.ts` (new)
- `packages/testkit/src/index.ts` (update exports)
- `packages/testkit/src/register.ts` (ensure it imports bootstrap side-effects)
- Test file templates in docs
- Example test migrations

## Dependencies

- [x] Task 013: Mock factory must be implemented first
- [x] Understanding of current test import patterns

## Effort Estimate

- Size: M
- Hours: 6-8
- Parallel: false (builds on Task 013)

## Definition of Done

- [x] Bootstrap module created and exported
- [x] All vi.mock calls consolidated in bootstrap
- [x] Registry initialization in correct order
- [x] Test templates demonstrate usage
- [x] Migration guide written
- [x] Tests consistently pass with new import pattern
- [x] Clear error messages for incorrect usage
- [x] Verified under both module specifiers for child_process and across runners
