---
name: Enforce import order with bootstrap
status: open
created: 2025-09-20T21:07:43Z
updated: 2025-09-21T00:00:00Z
github: # Will be updated when synced to GitHub
depends_on: [013]
parallel: false
conflicts_with: []
---

# Task: Enforce import order with bootstrap

## Description

Create a testkit bootstrap module that ensures vi.mock declarations and registry initialization happen before any consumer imports. This guarantees correct mock installation order and prevents timing-sensitive failures.

## Acceptance Criteria

- [ ] Bootstrap module created that hoists all vi.mock declarations
- [ ] Registry initialization happens in bootstrap before consumer code
- [ ] Clear import pattern documented for test files
- [ ] Test templates provided showing correct usage
- [ ] Bootstrap handles all mockable modules (child_process, fs, etc.)
- [ ] Import order violations produce clear error messages
- [ ] Bootstrap integrates with `packages/testkit/src/register.ts` to ensure setupFiles usage works in both Vitest and Wallaby
- [ ] Works when tests use either package-level or root-level vitest config (no drift)

## Technical Details

- Create `packages/testkit/src/bootstrap.ts` as entry point
- Bootstrap must be imported before test code
- Consider using side-effect imports for initialization
- May need to restructure test file imports
- Provide migration guide for existing tests

Key files affected:

- `packages/testkit/src/bootstrap.ts` (new)
- `packages/testkit/src/index.ts` (update exports)
- `packages/testkit/src/register.ts` (ensure it imports bootstrap side-effects)
- Test file templates in docs
- Example test migrations

## Dependencies

- [ ] Task 013: Mock factory must be implemented first
- [ ] Understanding of current test import patterns

## Effort Estimate

- Size: M
- Hours: 6-8
- Parallel: false (builds on Task 013)

## Definition of Done

- [ ] Bootstrap module created and exported
- [ ] All vi.mock calls consolidated in bootstrap
- [ ] Registry initialization in correct order
- [ ] Test templates demonstrate usage
- [ ] Migration guide written
- [ ] Tests consistently pass with new import pattern
- [ ] Clear error messages for incorrect usage
- [ ] Verified under both module specifiers for child_process and across runners
