---
task_id: 005
name: Establish Convex test harness
description: Create testing utilities for Convex functions and backend using convex-test with a thin adapter.
status: in-progress
priority: high
tags: convex, backend, testing
created: 2025-09-20T03:22:42Z
updated: 2025-09-22T00:00:00Z
---

# Task 005: Establish Convex test harness

## Description

Set up a reliable Convex test harness built on convex-test, exposing a minimal
adapter (db/auth/storage/scheduler/lifecycle) that mirrors documented
convex-test patterns and avoids stubs.

## Acceptance Criteria

- [ ] M0: Adapter hardening
  - [ ] Identity wiring fixed (`createAuthenticatedConvexTest`, `lifecycle.reset`)
  - [ ] No stubbed helpers in public API (unimplemented methods throw)
  - [ ] Scheduler cleanup accepts `advanceTimers` and is documented
  - [ ] Smoke tests: `t.run`, identity isolation, scheduled chains, `t.fetch`
- [ ] M1: Developer ergonomics
  - [ ] `setUser/clearUser` mutating APIs + documented fluent pattern (`withUser`)
  - [ ] Seed helpers implemented over `t.run`; deterministic factories supported
  - [ ] Modules example using `import.meta.glob` + `convexTest(schema, modules)`
- [ ] M2: Docs & templates
  - [ ] Cookbook: auth, seeding, scheduler with fake timers, HTTP actions via `t.fetch`
  - [ ] Config notes to keep Wallaby/Vitest aligned (node env, setupFiles)

## Technical Details

### Files

- `packages/testkit/src/convex/harness.ts` (adapter)
- `packages/testkit/src/convex/context.ts` (types)
- `packages/testkit/src/convex/auth.ts` (identity helpers)
- `packages/testkit/src/convex/factories.ts` (light factories)
- `packages/testkit/src/convex/matchers.ts` (optional sugar)
- `packages/testkit/examples/convex.test.ts` (smoke/cookbook)

Reference implementation uses `convexTest(schema, modules)` under the hood,
re-exported via the adapter with identity and lifecycle conveniences.

### Features to Implement

- Identity helpers
- Seed helpers
- Minimal assertion sugar (optional)
- Scheduler helpers (`finishInProgress`, `finishAll(advanceTimers)`) wired to timers
- HTTP action helper usage via `t.fetch`

## Implementation Notes

- Support both fluent and mutating identity flows; document clearly
- Use `t.run` for seeding and storage to match convex-test behavior
- Pair scheduled tests with `vi.useFakeTimers()` and `vi.runAllTimers()` before finishing
- Prefer generated Convex types in consumers (`_generated/api`, `_generated/server`)
- Test HTTP actions via `t.fetch` rather than mocking global `fetch`
