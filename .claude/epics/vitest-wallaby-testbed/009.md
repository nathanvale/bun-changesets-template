---
task_id: 009
name: Setup CLI command mocking utilities
description: Create utilities for mocking and testing CLI commands
status: todo
priority: medium
tags: cli, mocking, child_process
created: 2025-09-20T03:22:42Z
---

# Task 009: Setup CLI command mocking utilities

## Description

Implement utilities for mocking child process execution and testing CLI commands
in both unit and integration contexts.

## Acceptance Criteria

- [ ] Mock child_process.exec and spawn
- [ ] Create stdout/stderr capture utilities
- [ ] Implement exit code simulation
- [ ] Provide sandbox CLI execution helpers
- [ ] Create common CLI testing patterns

## Technical Details

### File: `packages/testkit/src/cli/mock.ts`

```typescript
import { vi } from 'vitest'
import * as child_process from 'child_process'

export const cliHelpers = {
  mockExec: (outputs: { stdout?: string; stderr?: string; error?: Error }) => {
    return vi.spyOn(child_process, 'exec').mockImplementation((cmd, cb) => {
      if (outputs.error) {
        cb(outputs.error, null, null)
      } else {
        cb(null, { stdout: outputs.stdout || '', stderr: outputs.stderr || '' })
      }
    })
  },

  captureOutput: () => {
    const stdout: string[] = []
    const stderr: string[] = []

    vi.spyOn(process.stdout, 'write').mockImplementation((chunk) => {
      stdout.push(chunk.toString())
      return true
    })

    return { stdout, stderr }
  },
}
```

### Features to Implement

- Process spawn mocking
- Interactive CLI testing
- Environment variable injection
- Working directory management
- Signal handling simulation

## Implementation Notes

- Support both callback and promise-based APIs
- Provide helpers for common CLI tools (git, npm, etc.)
- Enable sequential command simulation
- Document patterns for testing piped commands
- Consider cross-platform compatibility
