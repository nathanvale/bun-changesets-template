---
task_id: 009
name: Setup CLI command mocking utilities
description: Create utilities for mocking and testing CLI commands
status: todo
priority: medium
tags: cli, mocking, child_process
created: 2025-09-20T03:22:42Z
---

# Task 009: Setup CLI command mocking utilities

## Description

Implement utilities for mocking child process execution and testing CLI commands
in both unit and integration contexts.

## Acceptance Criteria

- [ ] Provide tri-register helpers (spawn, exec, execSync) with safe defaults
- [ ] Support both module specifiers: `child_process` and `node:child_process`
- [ ] Enforce mock-at-declaration via setupFiles (factory once available)
- [ ] Bootstrap/register ensures correct import order before consumers
- [ ] Common patterns for git/npm/docker helpers and builder API
- [ ] Unify runner setup between Vitest and Wallaby; CI reporters output to `./test-results/`

## Technical Details

### Files

- `packages/testkit/src/cli/process-mock.ts` — core mocking and `processHelpers`
- `packages/testkit/src/cli/spawn.ts` — builder and `commonCommands`
- `packages/testkit/src/register.ts` — setupFiles wiring (and future factory usage)

### Usage

```ts
import { processHelpers } from 'packages/testkit/src/cli/process-mock.js'
import { mockSpawn } from 'packages/testkit/src/cli/spawn.js'

processHelpers.mockSuccess(/git status/, 'nothing to commit\n')
mockSpawn('docker build -t my:tag').stdout('Successfully built my:tag').exitCode(0).mock()
```

### Features to Implement

- Interactive CLI testing patterns (stdin/stdout helpers if needed)
- Environment variable injection helpers (optional)
- Working directory management helpers (optional)
- Signal handling simulation via MockChildProcess.kill()

## Implementation Notes

- Factory-at-mock-time replaces runtime delegation once 013 is implemented
- Register/bootstrap must run before consumers (014)
- Tri-register helpers by default; allow narrowing for spawn-only cases (015)
- Single source of truth for setupFiles/env; unify CI reporters (016)

## Dependencies

- 013: Mock factory integration
- 014: Bootstrap import order
- 015: Helper semantics alignment
- 016: Runner config unification

## Definition of Done

- Helpers support spawn/exec/execSync with safe defaults and strong types
- Dual-specifier compatibility verified (child_process and node:child_process)
- SetupFiles enforce mock-at-declaration and correct order across Vitest/Wallaby
- Docs updated with examples; CI reporters generated under `./test-results/`
