---
name: Implement single authoritative mock factory
status: open
created: 2025-09-20T21:07:43Z
updated: 2025-09-21T00:00:00Z
github: # Will be updated when synced to GitHub
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Implement single authoritative mock factory

## Description

Replace the current runtime-conditional global mock installation with a single authoritative mock factory that's guaranteed to be created at mock time, not patched later. This addresses the fundamental incompatibility with vi.mock hoisting.

## Acceptance Criteria

- [ ] Create centralized mock factory function that returns mocked child_process module
- [ ] Ensure factory is declared in vi.mock call before any consumer imports
- [ ] Factory pulls behavior from ProcessMocker registry but creates mocks at declaration time
- [ ] Support both 'child_process' and 'node:child_process' module specifiers
- [ ] All mock methods (spawn, fork, exec, execSync, execFile, execFileSync) properly initialized with safe defaults
- [ ] No runtime patching or delegate installation after module load
- [ ] Strong TypeScript types for the returned mocked module and registration API
- [ ] Clear error messages when no matching mock config is found (including which matcher failed)

## Technical Details

- Create `createChildProcessMock()` factory in testkit
- Use vi.mock in setup file with factory function
- Factory returns complete mock implementation at mock time
- ProcessMocker state management remains but accessed differently
- Must handle both CJS and ESM module resolution
- Ensure compatibility when consumers import either `child_process` or `node:child_process`

 Key files affected:

- `packages/testkit/src/cli/mock-factory.ts` (new)
- `packages/testkit/src/cli/process-mock.ts` (refactor)
- `packages/testkit/src/register.ts` (update to wire vi.mock with factory)
- `packages/testkit/vitest.config.ts` (setupFiles)

## Dependencies

- [ ] No task dependencies - this is the foundation
- [ ] Requires understanding of current ProcessMocker implementation

## Effort Estimate

- Size: L
- Hours: 8-12
- Parallel: false (foundational change)

## Definition of Done

- [ ] Mock factory implemented and exported
- [ ] vi.mock declaration uses factory directly
- [ ] All child_process methods mocked at declaration time
- [ ] Proved working for both specifiers: `child_process` and `node:child_process`
- [ ] Tests pass consistently in both Vitest and Wallaby (no late patching)
- [ ] No runtime patching or global installation
- [ ] Documentation updated with new approach
- [ ] Minimal spike/test documented demonstrating usage in a test file and in the package setup
