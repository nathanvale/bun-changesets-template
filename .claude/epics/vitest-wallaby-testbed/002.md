---
task_id: 002
name: Implement MSW server configuration
description: Set up Mock Service Worker for HTTP/API mocking in tests
status: closed
priority: high
tags: msw, mocking, http
created: 2025-09-20T03:22:42Z
updated: 2025-09-20T04:53:45Z
---

# Task 002: Implement MSW server configuration

## Description

Create the MSW (Mock Service Worker) server configuration for intercepting and
mocking HTTP requests in both unit and integration tests.

## Acceptance Criteria

- [x] Create MSW server instance for Node.js environment with singleton pattern
- [x] Implement default handlers for common scenarios
- [x] Set up proper lifecycle hooks (beforeAll, afterEach, afterAll)
- [x] Configure strict mode with `onUnhandledRequest: 'error'`
- [x] Create utility functions for common mocking patterns
- [x] Global setup integration with Vitest workspace
- [x] Example handlers for Vite demo app
- [x] Vite app integration with testkit MSW

## Implemented Architecture

### Core Files

**`packages/testkit/src/msw/server.ts`** - Singleton MSW server with lifecycle
management **`packages/testkit/src/msw/config.ts`** - Environment-aware
configuration **`packages/testkit/src/msw/setup.ts`** - Setup utilities for
different test scenarios **`packages/testkit/src/msw/handlers.ts`** - Common
handlers and response builders **`packages/testkit/vitest.globalSetup.ts`** -
Global MSW setup for all test suites

### Key Features

1. **Singleton Pattern**: Single MSW server instance shared across tests
2. **Environment Detection**: Automatic config based on CI/Wallaby/local
3. **Strict Mode**: Consistent `onUnhandledRequest: 'error'` across environments
4. **Global Setup**: MSW initialized once via Vitest globalSetup
5. **Example Handlers**: Ready-to-use handlers for demo applications

### Usage Patterns

```typescript
// Basic setup in test files
import { setupMSW } from '@template/testkit/msw'
import { viteDemoHandlers } from '@template/testkit/msw'

setupMSW(viteDemoHandlers, {
  onUnhandledRequest: 'error',
  quiet: false,
})
```

### Integration Points

- **Vitest Workspace**: Global setup configured for all test projects
- **Vite Demo App**: Uses testkit handlers via `@template/testkit/msw`
- **Quality Check**: MSW mocks pass through quality validation

## Migration Notes

- Vite app handlers migrated from local implementation to testkit
- Server setup standardized across all consuming applications
- Global setup eliminates duplicate MSW initialization
